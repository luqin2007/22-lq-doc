# 概念模型
![[../../../../_resources/images/Pasted image 20241116235114.png]]
> [!note] RPC 调用相关概念
> IDL：Interface description language，提供方法的接口描述，使不同平台不同语言的对象可以互相通信
> 生成代码：编译器使用工具将 IDL 转换成对应语言的静态库
> 编解码：字节序列与目标对象的转换，解决跨语言数据格式
> 通信协议：规范数据在网络中的传输内容和格式，包括请求/响应数据、元数据等
> 网络传输：基于成熟 TCP/UDP 网络库传输

使用 RPC 的优点有：
- 单一职责，利于分工协作和运维开发
- 可扩展性强，可灵活调整服务资源使用
- 故障隔离
# 分层设计
## 编解码层

> [!note] 常用的编解码格式有
> - 语言特定格式：如 `java.io.Serializeable`，兼容性较差
> - 文本格式：如 Json。xml，CSV 等，具有良好的可读性，但约束不强，且编解码常依赖于反射实现，性能较差
> - 二进制格式：如 Protobuf，Thrift 的 BinaryProtocol 等，信息紧凑，性能更高

选择编码常需要考虑以下内容：
- 兼容性：维护（修改） IDL 时确保向下兼容
- 通用性：跨平台，流行度等
- 性能：编解码耗时、数据大小（描述字段）
## 协议层

协议构造中，协议各个数据单元之间的区分方法
- 固定长度：字段占用固定字节数
- 特殊结束符：以特殊字符作为每个协议单元结束的标识（如 HTTP 使用换行符）
- 变长协议：前面添加一个长度标识 `len`
## 网络通信层

使用 SocketAPI 进行通信，通常使用第三方库，选择通常考虑以下内容：
- API：对底层 Socket API 封装、连接管理和事件分发的易用性
- 功能：协议支持是否全面（TCP、UDP、UDS 等），是否支持优雅退出、异常处理等
- 性能：buffer 减少 copy，高性能定时器、对象池等
![[../../../../_resources/images/Pasted image 20241117001324.png]]
# 关键指标
## 稳定性
### 稳定性策略

保障策略
- 熔断：保护调用方，防止由于超时产生大量重复调用，被调服务出现问题影响整个链路
- 限流：保护被调方，防止大流量将服务压垮
- 超时控制：避免浪费资源在不可用节点
请求成功率
- 负载均衡，防止某个服务节点压力过大
- 重试：重试几次调用增加成功率
长尾请求：使用 Backup Request。在大部分情况下都会返回的时间（99%）还未返回时就发送一个重试（备份）请求，不再等待第一次请求
### 实现

通过注入策略，使用中间件实现
![[../../../../_resources/images/Pasted image 20241117003127.png]]
## 易用性

- 开箱即用：合理的默认参数和丰富的文档
- 周边工具：生成代码工具、脚手架等辅助工具，减少重复工作
## 扩展性

- 中间件 Middleware：在本地端到远端之间的调用链
- 参数 Option
- 编解码层：支持多种编解码
- 协议层：支持多种协议
- 网络传输层：支持多种网络库
- 代码生成工具插件扩展
## 观测性

- Log + Metric + Tracing（日志、监控、跟踪）
- 内置观测性服务，通过特定接口查看当前环境和运行状态
## 高性能

目标：
- 高吞吐：单位时间内处理更多请求
- **低延迟**：处理每个请求的时间尽可能短

手段
- 连接池
- 多路复用
- 高性能编解码协议
- 高性能网络库
# KiteX
![[../../../../_resources/images/Pasted image 20241117004047.png]]
- 感知连接状态：`epoll` 主动监听机制
- `goroutine` 暴涨：连接池
- 提升性能：引入 `Nocopy Buffer`，实现编解码层零拷贝
## 网络层优化

- 调度优化：`epoll_wait` 调度控制、`gopool` 重用 `goroutine`
- `LinkBuffer`：读写行无锁，支持 `nocopy` 流式读写，高效扩缩容
- 池化：内存池+对象池+ `NocopyBuffer` 池，减少 GC
## 编解码优化

- `Codegen`
	- 预计算、预分配内存，减少内存操作
	- `inline` 减少函数调用，避免反射
	- `Thriftgo`：自研 `Thrift IDL` 解析和代码生成器，插件
- `JIT`：动态 `Thrift` 编解码器 `Frugal`
## 合并部署

微服务过微，传输和序列化开销越来越大。

将亲和性强的服务实例尽可能调度到同一个物理机，将远程 RPC 调用优化为本地 IPC 调用